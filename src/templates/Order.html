<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Đặt hàng</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- <link rel="stylesheet" href="./public/css/style.css" />
    <script src="./public/js/Order.js"></script> -->
  </head>
  <body>
    <div class="container-fluid mt-5">
      <h2 class="text-center">Đặt Hàng</h2>
      <form action="#" class="was-validated" novalidate>
        <!-- psid -->

        <input type="text" id="psid" hidden />

        <!-- Tên -->
        <div class="mb-3">
          <label for="name" class="form-label">Họ và Tên:</label>
          <input
            type="text"
            class="form-control"
            id="name"
            placeholder="Nhập họ và tên"
            name="name"
            required
          />
          <div class="valid-feedback">Hợp lệ.</div>
          <div class="invalid-feedback">Vui lòng điền họ và tên.</div>
        </div>

        <!-- Số điện thoại -->
        <div class="mb-3">
          <label for="sdt" class="form-label">Số điện thoại:</label>
          <input
            type="tel"
            class="form-control"
            id="sdt"
            placeholder="Nhập số điện thoại"
            name="sdt"
            pattern="[0][0-9]{9}"
            required
          />
          <div class="valid-feedback">Hợp lệ.</div>
          <div class="invalid-feedback">
            Vui lòng nhập số điện thoại hợp lệ (10 chữ số).
          </div>
        </div>

        <!-- Địa chỉ -->
        <div class="mb-3">
          <label for="adress" class="form-label">Địa Chỉ:</label>
          <input
            type="text"
            class="form-control"
            id="adress"
            placeholder="Nhập địa chỉ"
            name="adress"
            required
          />
          <div class="valid-feedback">Hợp lệ.</div>
          <div class="invalid-feedback">Vui lòng điền địa chỉ.</div>
        </div>

        <!-- Menu Sản Phẩm -->
        <div id="selectMenu"></div>

        <!-- Thêm sản phẩm -->
        <div class="text-center mb-3">
          <button type="button" class="btn btn-success" id="themSanPham">
            <i class="bi bi-plus-lg"></i> Thêm sản phẩm
          </button>
        </div>

        <!-- Đặt Hàng -->
        <button type="submit" class="btn btn-primary w-100" id="Order">
          Đặt Hàng
        </button>
      </form>
    </div>

    <script>
      // Dữ liệu sản phẩm
      const cacSanPham = {
        vest: ["Vest xanh", "Vest đen", "Vest kẻ sọc"],
        ghile: ["Ghile nâu", "Ghile xám", "Ghile kẻ"],
        ao_so_mi: ["Áo sơ mi trắng", "Áo sơ mi xanh", "Áo sơ mi họa tiết"],
      };

      const selectMenu = document.getElementById("selectMenu");
      const themSanPham = document.getElementById("themSanPham");

      // Tạo phần chọn sản phẩm mới
      function taoSanPhamMoi() {
        const divSanPham = document.createElement("div");
        divSanPham.className = "mb-3 product-item";

        // Tạo dropdown chọn loại sản phẩm
        const selectMenuType = document.createElement("select");
        selectMenuType.className = "form-select mb-2 product-type";
        selectMenuType.required = true;
        selectMenuType.innerHTML = `
          <option value="" disabled selected>Chọn loại sản phẩm</option>
          <option value="vest">Vest</option>
          <option value="ghile">Ghile</option>
          <option value="ao_so_mi">Áo sơ mi</option>
        `;

        // Dropdown chọn sản phẩm
        const selectMenuList = document.createElement("select");
        selectMenuList.className = "form-select product-list";
        selectMenuList.required = true;
        selectMenuList.innerHTML = `<option value="" disabled selected>Chọn sản phẩm</option>`; // Đặt mặc định

        // Sự kiện thay đổi loại sản phẩm
        selectMenuType.addEventListener("change", function () {
          const selectedType = selectMenuType.value;

          // Xóa các tùy chọn sản phẩm cũ
          selectMenuList.innerHTML = `<option value="" disabled selected>Chọn sản phẩm</option>`; // Đặt lại mặc định

          // Thêm các tùy chọn mới dựa trên loại sản phẩm
          cacSanPham[selectedType].forEach((product) => {
            const option = document.createElement("option");
            option.value = product;
            option.textContent = product;
            selectMenuList.appendChild(option);
          });
        });

        // Thêm các phần tử vào divSanPham
        divSanPham.appendChild(selectMenuType);
        divSanPham.appendChild(selectMenuList);

        // Thêm divSanPham vào khu vực sản phẩm
        selectMenu.appendChild(divSanPham);
      }

      // Sự kiện click vào nút "Thêm sản phẩm"
      themSanPham.addEventListener("click", taoSanPhamMoi);
      (function (d, s, id) {
        var js,
          fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
          return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/messenger.Extensions.js";
        fjs.parentNode.insertBefore(js, fjs);
      })(document, "script", "Messenger");
      alert("hello");
      window.extAsyncInit = function () {
        // the Messenger Extensions JS SDK is done loading
        MessengerExtensions.getContext(
          "773997401470202",
          function success(thread_context) {
            document.getElementById("psid").value = thread_context.psid;
            handleClickButtonOrder();
          },
          function error(err) {
            console.log("Lỗi đặt hàng: ", err);
          }
        );
      };

      function checkValidate() {
        let ten = document.getElementById("name").value;
        let sdt = document.getElementById("sdt").value;
        let diachi = document.getElementById("adress").value;
        if (ten !== "" && sdt.match(/^0\d{9}$/) && diachi != "") {
          return true;
        }
        return false;
      }
      function handleClickButtonOrder() {
        const orderButton = document.getElementById("Order");
        orderButton.addEventListener("click", function (event) {
          let checkValidate = checkValidate();
          const data = {
            psid: document.getElementById("psid").value,
            ten: document.getElementById("name").value,
            sdt: document.getElementById("sdt").value,
            diachi: document.getElementById("adress").value,
          };
          const url = `${window.location.origin}/handle-order`;
          if (checkValidate) {
            MessengerExtensions.requestCloseBrowser(
              function success() {
                // webview closed
              },
              function error(err) {
                console.log(err);
              }
            );
            fetch(url, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Network response was not ok");
                }
                return response.json();
              })
              .then((data) => {
                console.log(data);
              })
              .catch((error) => {
                console.log(error);
              });
          } else {
            console.log("Dữ liệu không hợp lệ!");
          }
        });
      }
    </script>
  </body>
</html>
